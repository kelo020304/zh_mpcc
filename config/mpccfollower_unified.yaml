# ============================================================
# Unified MPCC Follower Configuration
# 全向底盘统一MPCC路径跟踪控制器参数
# 支持自动前进/倒车/原地旋转
# ============================================================

# ------------ ROS 接口配置 ------------
odom_topic: /localization
sensorOffsetX: 0.0
sensorOffsetY: 0.0

# ------------ MPC 求解器配置 ------------
mpc_hz: 50.0
mpc_horizon: 30

# ------------ 速度与控制约束 ------------
autonomyMode: true
autonomySpeed: 0.6
maxSpeed: 0.6

# ------------ 速度平滑 ------------
enable_cmd_smoothing: true
cmd_smooth_tau: 0.8
cmd_max_accel_lin: 0.5
cmd_max_accel_ang: 1.0

# 底盘类型：omni/holonomic 时使用路径姿态
chassis_type: holonomic

# 机器人速度上下界（全向底盘）
vx_max: 1.0
vy_max: 1.0
w_max: 1.0

# 路径速度约束（沿着路径前进的速度）
# **KEY CHANGE: 允许负值进行倒车**
vs_max: 1.0   # 最大路径速度（前进）[米/秒]
vs_min: -1.0  # 最小路径速度（倒车）[米/秒] - 增大倒车速度上限

s_trust: 1.5

# ------------ MPC 代价函数权重（中间步） ------------
qC: 50.0     # 轮廓误差权重（增大以减少路径偏离）
qL: 5.0      # 滞后误差权重
qYaw: 30.0   # 航向误差权重（适当增大以改善转向）

# ------------ MPC 代价函数权重（终端步） ------------
qC_f: 100.0  # 终端轮廓误差权重（增大以精确到达目标）
qL_f: 10.0
qYaw_f: 30.0 # 终端航向误差权重（增大以精确对齐）

# ------------ MPC 控制输入惩罚权重 ------------
rVx: 1.0
rVy: 1.0
rW: 2.0      # 角速度惩罚（增大以减少转向超调）
rVs: 1.0

# ------------ 路径速度奖励与方向引导 ------------
qVs: 0.1  # 基础路径速度奖励权重（鼓励前进）

# **NEW: 方向引导参数**
qVsDir: 1.0        # 方向引导权重（鼓励vs符号匹配路径方向）
                   # 越大越严格遵循路径指定的前进/倒车方向
                   # 设为0则完全由优化器自由选择方向
                   # 增大到20.0以克服档位切换惩罚

qGearSwitch: 0.5   # 档位切换惩罚权重（避免频繁换挡）
                   # 越大越平滑，但可能延迟必要的换挡
                   # 减小到2.0允许必要的换挡

rInPlaceRot: 0.1   # 原地旋转段控制惩罚降低系数
                   # 小于1.0，让原地旋转更灵活

# ------------ 加速度约束（控制平滑）------------
enable_mpc_du_penalty: true  # 启用MPC加速度软约束
rDuVx: 10.0   # vx变化惩罚权重（越大越平滑）
rDuVy: 10.0   # vy变化惩罚权重（越大越平滑）
rDuW: 3.0     # w变化惩罚权重（越大越平滑）
rDuVs: 1.0    # vs变化惩罚权重（越大越平滑）

# ------------ 停止条件 ------------
stop_dis_thre: 0.02

# ------------ 末端航向对齐 ------------
align_dist_thre: 0.5
align_pos_thre: 0.05
align_pos_speed: 0.1
align_yaw_thre_deg: 15.0
align_yaw_speed: 0.3
align_timeout_s: 10.0

# ------------ 路径方向检测 ------------
# **NEW: 自动从路径中检测前进/倒车/原地旋转**
use_path_direction_hint: true   # 启用路径方向引导（强烈推荐）
in_place_rot_threshold: 0.10    # 原地旋转检测阈值 [m]
                                # 使用向前看策略累积距离判断
                                # 只有累积距离<阈值且姿态变化大时才判定为旋转

# ============================================================
# 关键改进说明
# ============================================================
# 1. **统一优化框架**：vs可在[-vs_max, vs_max]全范围内优化，
#    不再硬编码档位限制
#
# 2. **路径方向自动推断**：从路径点的姿态和运动方向自动推断
#    期望行进方向（前进/倒车/原地旋转）
#
# 3. **软约束引导**：通过代价函数qVsDir引导vs符号，而非硬约束
#    允许优化器在必要时偏离引导
#
# 4. **原地旋转自动处理**：检测到原地旋转段时，自动调整权重：
#    - 增加contour error权重（保持位置）
#    - 减小lag error权重（允许s不变）
#    - 降低控制惩罚（允许更大角速度）
#
# 5. **档位切换平滑**：通过qGearSwitch惩罚vs符号变化，
#    避免频繁前进-倒车切换
#
# ============================================================
# 调参建议
# ============================================================
#
# **场景1：严格按路径方向行驶（推荐）**
# qVsDir: 5.0~10.0  # 强引导
# qGearSwitch: 5.0~10.0
#
# **场景2：允许优化器自由选择方向**
# qVsDir: 0.0       # 无引导
# qGearSwitch: 2.0  # 轻微惩罚
#
# **场景3：倒车轨迹难以跟随**
# - 检查路径规划器是否正确设置路径点姿态
# - 增加qVsDir权重
# - 减小qGearSwitch（允许更快换挡）
#
# **场景4：原地旋转不够灵活**
# - 减小in_place_rot_threshold（更早检测原地旋转）
# - 减小rInPlaceRot（降低旋转控制惩罚）
# - 增加w_max（允许更大角速度）
#
# ============================================================
