# ============================================================
# MPCC Follower Configuration
# Model Predictive Contouring Control 路径跟踪控制器参数
# ============================================================

# ------------ ROS 接口配置 ------------
odom_topic: /localization  # 里程计话题名称（接收机器人位姿）

# 传感器偏移（从传感器坐标系到机器人中心的偏移）
sensorOffsetX: 0.0  # X 方向偏移 [米]
sensorOffsetY: 0.0  # Y 方向偏移 [米]

# ------------ MPC 求解器配置 ------------
mpc_hz: 50.0        # MPC 控制频率 [赫兹]
mpc_horizon: 100     # MPC 预测步数（预测时域长度）[步]
                    # 预测时长 = mpc_horizon / mpc_hz 

# ------------ 速度与控制约束 ------------
# 速度来源（/speed 不存在时建议开启自主速度）
autonomyMode: true
autonomySpeed: 2.0
maxSpeed: 2.0
# ------------ 速度平滑 ------------
enable_cmd_smoothing: true
cmd_smooth_tau: 0.5       # 时间常数 [s]，越大越平滑
cmd_max_accel_lin: 0.5    # 线速度加速度上限 [m/s^2]
cmd_max_accel_ang: 1.0    # 角速度加速度上限 [rad/s^2]

# 底盘类型：omni/holonomic 时使用路径姿态（支持原地转向）
chassis_type: holonomic
# 机器人速度上下界（全向底盘）
vx_max: 2.0   # X 方向最大速度 [米/秒]
vy_max: 2.0   # Y 方向最大速度 [米/秒]
w_max: 1.0    # 最大角速度 [弧度/秒]

# 路径速度约束（沿着路径前进的速度）
vs_max: 2.0   # 最大路径速度 [米/秒]（降低到 0.5，让对齐阶段更慢）
vs_min: -2.0  # 最小路径速度 [米/秒]（负值允许倒车）

# 路径参数信任范围（防止路径参数 s 过度偏离当前值）
s_trust: 1.5  # 路径参数变化范围 [米]

# ------------ MPC 代价函数权重（中间步） ------------
# 跟踪误差权重（越大越重视跟踪精度，但可能导致抖动）
qC: 20.0     # 轮廓误差权重（contour error，垂直于路径方向的误差）[无量纲]
qL: 5.0      # 滞后误差权重（lag error，沿路径方向的误差）[无量纲]
qYaw: 10.0   # 航向误差权重（机器人朝向与路径切线的偏差）[无量纲]

# ------------ MPC 代价函数权重（终端步） ------------
# 终端步权重通常设置为中间步的 2 倍，加强终点处的跟踪精度
qC_f: 40.0   # 终端轮廓误差权重 [无量纲]
qL_f: 10.0   # 终端滞后误差权重 [无量纲]
qYaw_f: 20.0 # 终端航向误差权重 [无量纲]

# ------------ MPC 控制输入惩罚权重 ------------
# 控制惩罚（越大越平滑，但响应变慢）
rVx: 0.5   # X 方向速度控制惩罚 [无量纲]
rVy: 1.0   # Y 方向速度控制惩罚 [无量纲]
rW: 0.9    # 角速度控制惩罚 [无量纲]
rVs: 0.5   # 路径速度控制惩罚 [无量纲]

# 路径速度奖励（鼓励沿着路径前进）
qVs: 0.3  # 路径速度奖励权重（降低到 0.05，减少速度激进程度）[无量纲]

# ------------ 停止条件 ------------
stop_dis_thre: 0.02  # 停止距离阈值 [米]
                    # 当机器人距离路径终点 < 此阈值时停止

# ------------ 末端航向对齐 ------------
align_dist_thre: 0.5       # 进入末端航向对齐距离阈值 [米]
align_pos_thre: 0.05       # 末端直线对齐位置阈值 [米]
align_pos_speed: 0.1      # 末端直线对齐速度 [m/s]
align_yaw_thre_deg: 10.0   # 航向对齐阈值 [度]
align_yaw_speed: 0.3       # 航向对齐角速度 [rad/s]
align_timeout_s: 10.0       # 末端对齐超时 [s]

# ------------ 自动档位（前进/倒车/原地旋转）------------
gear_auto_enable: true       # 根据轨迹自动判断前进/倒车/原地旋转
rotate_path_len_thre: 0.01   # 路径总长度小于该值时进入原地旋转挡 [m]
rotate_ds_thre: 0.01         # 局部相邻点距离小于该值且航向误差大时进入原地旋转挡 [m]
rotate_yaw_thre_deg: 40.0    # 原地旋转挡触发的航向误差阈值 [度]
rotate_yaw_kp: 2.0           # 原地旋转挡航向比例系数
rotate_w_max: 1.0            # 原地旋转挡最大角速度 [rad/s]
